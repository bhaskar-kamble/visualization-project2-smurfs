---
title: "Project Report"
author: "Ivana Trajanovska, Pallavi Mitra and Bhaskar Kamble"
date: "23 Juni 2019"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    theme: united
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE,warning=FALSE)
#options(encoding="utf-8")
```

# 1. Abstract

The aim of this report is to investigate heating energy consumption in residential buildings in Germany over the time frame 2002-2018. The data on which this investigation is based come from the online portal of [co2online.de](www.co2online.de), which has information on more than two million households in this time frame. The information was provided by private individuals, who gave information relating to the building's energy consumption for a year and features relating to the building (age, area, fuel type, refurbishment measures already carried out, etc.) in return for an evaluation of the building's energy efficiency and suggested refurbishment
measures. The data are signifiicant from a political perspective, since energy consumption and the related CO2 emissions are major concerns in the backdrop of global warming and climate change.

All files used in this project are to be found in this [github](https://github.com/bhaskar-kamble/visualization-project2-smurfs) repository.


# 2. Source of the data

The data gathered over the years was stored in different forms in different databases over the years. For the statistical analysis the data engineers had to extract the data from the database and was initially delivered in 10 different csv/excel files. Collecting these data into a single object, imposing consistency over the different files, and removing duplicates all formed part of the data cleaning process. This process was rather involved and is described in [this](https://github.com/bhaskar-kamble/co2online_stats) github repository. The final data are stored in Rdata objects `MFH20022018_v3.Rdata` and `SFH20022018_v3.Rdata`. These are the starting point of our analysis.



# 3. Data extraction and description

## 3a. Getting and cleaning the data

```{r}

path_to_file <- "D:/GITHUB_REPOS/visualization-project2-smurfs/"
#path_to_file <- "~/Desktop/visualization-project2-smurfs/"

source(paste0(path_to_file , "getGermanyData.R"))
source(paste0(path_to_file , "cleanData.R"))
source(paste0(path_to_file , "getBundeslandfromCode.R"))
source(paste0(path_to_file , "getBundeslandfromLK.R"))
source(paste0(path_to_file , "getSpecificConsumptionByYear.R"))
source(paste0(path_to_file , "getConsumptionPerEnergieTraeger.R"))

#get data from the Rdata files, impose consistency in data types etc.
DL_MFH <- getGermanyData(gtype = "MFH")
DL_SFH <- getGermanyData(gtype = "SFH")

#remove outliers:
DL_MFH <- cleanData(DL_MFH , "MFH")
DL_SFH <- cleanData(DL_SFH , "SFH")

#find bundesland
DL_MFH <- getBundeslandfromCode(DL_MFH)
DL_SFH <- getBundeslandfromCode(DL_SFH)
DL_SFH <- DL_SFH[!is.na(DL_SFH$bundesland) , ]
DL_SFH <- getBundeslandfromLK(DL_SFH)
```

```{r}
source(paste0(path_to_file, "getCentroidsFromShapeFile.R"))
source(paste0(path_to_file , "getCo2Emissions.R"))

```


```{r}
# adding temperature data of winter 
temp_winter <- read.delim("GermanyWinterTemperatures.txt", header = FALSE, sep = "")
```


## 3b. Description of the data 

```{r}
str(DL_MFH)
```

Thus we see that there are `r nrow(DL_MFH)` observations for multifamily houses. The `energietraeger` is the source of fuel used for heating the building. The other variables of interest are the year of construction `gebaeude_baujahr`, the year in which the energy was measured (`abrechnungsjahr`), and the area of the building (`genaeude_nutzflaeche`).

```{r}
str(DL_SFH)
```

For 1-2 family houses there are `r nrow(DL_SFH)` observations.

# 4. Energy consumption trends across Germany

In this section we will analyze how the specific energy consumption (energy consumed per unit area) across Germany changes over the years.


## 4a. Specific Energy Consumtion trends

```{r}
MFH_spez_verbrauch <- getSpecificConsumptionByYear( DL_MFH , DL_SFH , gtype = "MFH")
SFH_spez_verbrauch <- getSpecificConsumptionByYear( DL_MFH , DL_SFH , gtype = "SFH")
ALL_spez_verbrauch <- getSpecificConsumptionByYear( DL_MFH , DL_SFH , gtype = "ALL")
```



```{r,fig.cap="\\label{fig:figs}Fig. 1: Specific energy consumption for Germany for multifamily (MFH), 1-2 family (SFH), and both (MFH+SFH combined) buildings."}
require(ggplot2)
gg_color_hue <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}
ggplot() + geom_point(data=MFH_spez_verbrauch , aes(x=abrechnungsjahr,y=spz_verbrauch,color="MFH")
)+geom_point(data=SFH_spez_verbrauch , aes(x=abrechnungsjahr,y=spz_verbrauch,color="SFH")
)+geom_point(data=ALL_spez_verbrauch , aes(x=abrechnungsjahr,y=spz_verbrauch,color="ALL")
)+geom_smooth(method="lm",data=MFH_spez_verbrauch,aes(x=abrechnungsjahr,y=spz_verbrauch),color=gg_color_hue(3)[2],se=FALSE
)+geom_smooth(method="lm",data=SFH_spez_verbrauch,aes(x=abrechnungsjahr,y=spz_verbrauch),color=gg_color_hue(3)[3],se=FALSE
)+geom_smooth(method="lm",data=ALL_spez_verbrauch,aes(x=abrechnungsjahr,y=spz_verbrauch),color=gg_color_hue(3)[1],se=FALSE
)+scale_color_discrete(name=" ",labels=c("ALL","MFH","SFH"))+scale_y_continuous(limits=c(0,150))+theme_bw()+scale_x_continuous(breaks=seq(2002,2018,2))+labs(x="Year",y=bquote("Specific Consumption" ~ (kWh/m^2)) )
```


From the above picture we can infer that the specific energy consumption for 1-2 family buildings is consistently higher than that of multifamily buildings, although the difference seems to be reducing in recent years. Overall the specific energy consumption shows a consistent decrease with the years for both types of buildings. This can be attributed to more stringent government norms which buildings constructed in recent years have to follow, making them more efficient. The other factor is the carrying out of refurbishment measures in old buildings resulting in an increase in their energy efficieny. A third factor resulting in the decrease in energy consumption is the climate. If we plot the winter temperatures from 2002 to 2018 in Germany, we get the following plot

```{r,fig.cap="\\label{fig:figs}Fig. 2: Winter temperatures in Germany from 2002-2018 (source: https://de.wikipedia.org/wiki/Zeitreihe_der_Lufttemperatur_in_Deutschland#2001_bis_2010)"}
germany_winter_temp <- read.table(paste0(path_to_file,"GermanyWinterTemperatures.txt"))
names(germany_winter_temp) <- c("Year","Temperature")
ggplot(data=germany_winter_temp,aes(x=Year,y=Temperature))+geom_point()+geom_smooth(method="lm",se=FALSE)+labs(y="Temperature (degrees Celsius)")
```


The plot shows an overall increase when one considers the linear trend, and hence has definitely contributed to the decrease in energy consumption. To what extent the decrease in energy consumption is caused by the aforementioned three factors is an interesting question which needs further investigation. One possible solution is to do a linear regression of the specific consumption as a function of temperature as a continuous variable and abrechnungsjahr as a categorical variable (after binning it suitably). This we do shortly.

In Fig. 1, there is a sharp increase in energy consumption for the year 2010. This corresponds to the extremely cold winter of the year 2010, as seen in Fig. 2, or in Fig. 3, which shows the annual mean of the temperature.


![Fig. 3: Temperatures in Germany from 1881 - 2018. Source: wikipedia](1000px-Zeitreihe_der_Temperaturen_in_Deutschland.svg.png)

In the next picture we plot the slope of the linear trend for the specific energy consumption. As can be seen, the slope for 1-2 family houses is indeed greater than that for multifamily houses (in terms of absolute value).


```{r,fig.cap="\\label{fig:figs}Fig. 4: Slopes for the linear trend of specific energy consumption for Germany."}
lm_mfh <- lm(spz_verbrauch ~ abrechnungsjahr , data = MFH_spez_verbrauch)
lm_sfh <- lm(spz_verbrauch ~ abrechnungsjahr , data = SFH_spez_verbrauch)
lm_all <- lm(spz_verbrauch ~ abrechnungsjahr , data = ALL_spez_verbrauch)
bmfh <- c(as.numeric(lm_mfh$coefficients[1]),as.numeric(lm_mfh$coefficients[2]))
bsfh <- c(as.numeric(lm_sfh$coefficients[1]),as.numeric(lm_sfh$coefficients[2]))
ball <- c(as.numeric(lm_all$coefficients[1]),as.numeric(lm_all$coefficients[2]))
slope_low  <- abs(c(confint(lm_mfh,"abrechnungsjahr",level=0.95)[2],confint(lm_sfh,"abrechnungsjahr",level=0.95)[2],confint(lm_all,"abrechnungsjahr",level=0.95)[2]))
slope_high  <- abs(c(confint(lm_mfh,"abrechnungsjahr",level=0.95)[1],confint(lm_sfh,"abrechnungsjahr",level=0.95)[1],confint(lm_all,"abrechnungsjahr",level=0.95)[1]))
slope_high <-
slopedata <- data.frame(gtype=c("MFH","SFH","Both"),slope=abs(c(bmfh[2],bsfh[2],ball[2])),slope_low=slope_low,slope_high=slope_high)
ggplot(data=slopedata,aes(x=gtype,y=slope))+geom_bar(stat="identity",width=0.5) + geom_errorbar(aes(ymin=slope_low,ymax=slope_high),width=0.2) + coord_flip() + labs(title="Rate of change of specific energy consumption in Germany (2002 - 2018)",x="Building type")+theme_bw()
```


Instead of treating the MFH and SFH buildings separately, we can model them together using `abrechnungsjahr` as a continuous variable and the building type as a categorical variable. We do this in the following figure.

```{r}
# Combining MFH and SFH data and adding gtype column
library(dplyr)
MFH_SFH_spez_verbrauch <- rbind(MFH_spez_verbrauch, SFH_spez_verbrauch )
MFH_SFH_spez_verbrauch$gtype <- c(rep('MFH', 17), rep('SFH', 17))

# binning the year and adding temp to each dataset
b <- c(2001, 2006, 2010, 2014, 2018)
names <- c("2002-2006", "2006-2010", "2010-2014", "2014-2018")
MFH_spez_verbrauch$yearbin <- cut(MFH_spez_verbrauch$abrechnungsjahr, breaks = b, labels = names) 
 
MFH_spez_verbrauch$temp <- temp_winter[,2]

SFH_spez_verbrauch$yearbin <- cut(SFH_spez_verbrauch$abrechnungsjahr, breaks = b, labels = names) 
 
SFH_spez_verbrauch$temp <- temp_winter[,2]

ALL_spez_verbrauch$yearbin <- cut(ALL_spez_verbrauch$abrechnungsjahr, breaks = b, labels = names) 
 
ALL_spez_verbrauch$temp <- temp_winter[,2]
```



```{r,fig.cap="\\label{fig:figs}Fig. 5: Multiple linear regression with year as continuous variable and building type as categorical variable without interaction between the two variables."}
## Multiple regression model without interaction  for MFH_SFH_spez_verbrauch
fit1=lm(spz_verbrauch ~ abrechnungsjahr + as.factor(gtype),data = MFH_SFH_spez_verbrauch)
#summary(fit1)
# for MFH
equation1=function(x){coef(fit1)[2]*x+coef(fit1)[1]}

# for SFH
equation2=function(x){coef(fit1)[2]*x+coef(fit1)[1]+coef(fit1)[3]}

ggplot(MFH_SFH_spez_verbrauch,aes(y=spz_verbrauch,x=abrechnungsjahr,color=gtype))+geom_point()+
        stat_function(fun=equation1,geom="line",color=scales::hue_pal()(2)[1])+
        stat_function(fun=equation2,geom="line",color=scales::hue_pal()(2)[2])+labs(title="MFH & SFH")+scale_x_continuous(name="Year", breaks =seq(2002, 2018, 2))+scale_y_continuous(limits=c(0,150)) +labs(x="Year", y=bquote("Specific Consumption" ~ (kWh/m^2)) )
```


As expected, the values for the specific consumption by SFH buildings are higher than those for the MFH buildings.


Adding interaction terms to a regression model can greatly expand understanding of the relationships among the variables in the model and allows more hypotheses to be tested.  The presence of a significant interaction indicates that the effect of one predictor variable on the response variable is different at different values of the other predictor variable. It would be useful to add an interaction term to the model if we wanted to test the hypothesis that the relationship between the abrechnungsjahr on the spz_verbrauch was different in buiding type i.e. mfh and sfh. The next figure shows the result of adding such an interaction term in the model.

```{r,fig.cap="\\label{fig:figs}Fig. 6: Multiple linear regression with year as continuous variable and building type as categorical variable with interaction between the two variables."}
## Multiple regression model with interaction 
fit2=lm(spz_verbrauch ~ abrechnungsjahr*as.factor(gtype),data = MFH_SFH_spez_verbrauch)
#summary(fit2)


# for MFH
equation1=function(x){coef(fit2)[2]*x+coef(fit2)[1]}

# for SFH
equation2=function(x){(coef(fit2)[2]+coef(fit2)[4])*x+(coef(fit2)[1]+coef(fit2)[3])}


ggplot(MFH_SFH_spez_verbrauch,aes(y=spz_verbrauch,x=abrechnungsjahr,color=gtype))+geom_point()+
        stat_function(fun=equation1,geom="line",color=scales::hue_pal()(2)[1])+
        stat_function(fun=equation2,geom="line",color=scales::hue_pal()(2)[2])+labs(title="MFH & SFH")+scale_x_continuous(name="Year", breaks =seq(2002, 2018, 2))+scale_y_continuous(limits=c(0,150))+labs(x="Year", y=bquote("Specific Consumption" ~ (kWh/m^2)) )
```

We next use a linear regression of the specific consumption as a function of temperature as a continuous variable and abrechnungsjahr as a categorical variable (after binning it suitably).

```{r,fig.cap="\\label{fig:figs}Fig. 7: Specific consumption as a function of temperature grouped by the year categories for multifamily buildings. The linear trends with temperature as continuous variable and year (binned) as categorical variable."}
# effect of temperature on MFH
fit3=lm(spz_verbrauch ~ temp + as.factor(yearbin),data = MFH_spez_verbrauch)
#summary(fit3)

# for 1st
equation1=function(x){coef(fit3)[2]*x+coef(fit3)[1]}

# for 2nd
equation2=function(x){coef(fit3)[2]*x+coef(fit3)[1]+coef(fit3)[3]}

# for 3rd
equation3=function(x){coef(fit3)[2]*x+coef(fit3)[1]+coef(fit3)[4]}

# for 4th
equation4=function(x){coef(fit3)[2]*x+coef(fit3)[1]+coef(fit3)[5]}

ggplot(MFH_spez_verbrauch,aes(y=spz_verbrauch,x=temp,color=as.factor(yearbin)))+geom_point()+
        stat_function(fun=equation1,geom="line",color=scales::hue_pal()(4)[1])+
        stat_function(fun=equation2,geom="line",color=scales::hue_pal()(4)[2])+
        stat_function(fun=equation3,geom="line",color=scales::hue_pal()(4)[3])+
        stat_function(fun=equation4,geom="line",color=scales::hue_pal()(4)[4])+
        labs(title="EFFECT OF TEMPERATURE IN MFH")+scale_x_continuous( limits=c(-2,5))+scale_y_continuous(limits=c(0,150))+labs(x="Temperature (degrees Celsius)" , y=bquote("Specific Consumption" ~ (kWh/m^2)) )
```


The above graph shows that the increase in temperature is not the sole reason for the decrease in specific consumption of energy. Refurbishment measures also play an important role. As expected, with increasing temperature, the specific energy consumption decreases. But for the four groups of `abrechnungsjahr`, the energy consumption perceptibly decreases following the temporal passage of the years.


```{r,fig.cap="\\label{fig:figs}Fig. 8: Specific consumption as a function of temperature grouped by the year categories for 1-2 family buildings. The linear trends with temperature as continuous variable and year (binned) as categorical variable."}
# effect of temperature on SFH
fit4=lm(spz_verbrauch ~ temp + as.factor(yearbin),data = SFH_spez_verbrauch)
#summary(fit4)

# for 1st
equation1=function(x){coef(fit4)[2]*x+coef(fit4)[1]}

# for 2nd
equation2=function(x){coef(fit4)[2]*x+coef(fit4)[1]+coef(fit4)[3]}

# for 3rd
equation3=function(x){coef(fit4)[2]*x+coef(fit4)[1]+coef(fit4)[4]}

# for 4th
equation4=function(x){coef(fit4)[2]*x+coef(fit4)[1]+coef(fit4)[5]}

ggplot(SFH_spez_verbrauch,aes(y=spz_verbrauch,x=temp,color=as.factor(yearbin)))+geom_point()+
        stat_function(fun=equation1,geom="line",color=scales::hue_pal()(4)[1])+
        stat_function(fun=equation2,geom="line",color=scales::hue_pal()(4)[2])+
        stat_function(fun=equation3,geom="line",color=scales::hue_pal()(4)[3])+
        stat_function(fun=equation4,geom="line",color=scales::hue_pal()(4)[4])+
        labs(title="EFFECT OF TEMPERTURE IN SFH")+scale_x_continuous(name="temp", limits=c(-2,5))+scale_y_continuous(limits=c(0,150))+labs(x="Temperature (degrees Celsius)"  , y=bquote("Specific Consumption" ~ (kWh/m^2)) )
```

The above graph also shows also that specific energy consumption in later years is lesser than that in earlier years for a given temperature. In addition, we have the somewhat surprising result that the temperature seems to play hardly any role in the specific consumption. 


# 5. CO2 emissions across Germany


In this section we analyze the carbon dioxide emissions for Germany in the time frame 2002-2018. The calculation proceeds as follows:

* From the specific consumption we have the consumption per unit area. We multiply this with the area of the MFH and SFH buildings to give the total consumption for Germany.

* From the data we can find the proportions of the energy fuels for the energy produced.

* From the above two can find how much energy was produced for which source of fuel.

* From the co2 coefficients we can find out how much co2 was produced in each year.

```{r}
library(plotly)
library(tidyr)
get_relative_frequencies_interactive <- function(data, title) {
  bundlands_energietraeger <- average_by_year_bundesland_energietrager(data)
  
  p <- plot_ly(type = 'bar', colors = "Blues") 
  
  p <- plot_ly(type = 'bar')
  v = TRUE
  for (i in 1:length(states)) {
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$erdgas, name = 'Erdgas',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$fluessiggas, name = 'Fluessiggas',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$heizoel, name = 'Heizoel',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$holzpellets, name = 'Holzpellets',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$strom, name = 'Strom',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$waerme, name = 'Waerme',  
                         x = 2002:2018, visible = v)
  
    v = FALSE
  }
  
  
  p <- p %>% layout(
      xaxis = list(range = c(2001, 2019)),
      barmode='stack',
      colorway = c('#e8288a','#1f9d75', '#e2ab07', '#756eb2', '#d95e00', '#68a61e'))
  
  p <- p %>% layout(
    title = title,
    xaxis = list(title = "Year", range = c(2001, 2019)),
    yaxis = list(title = "Value"),
    barmode ='stack',
    updatemenus = list(
      list(
        buttons = get_visibility_combinations()
      )
    )
  )
  return(p)
}
```


```{r}
library(plotly)
library(tidyr)
get_relative_frequencies_interactive_all <- function() {
  bundlands_energietraeger_all <- average_by_year_energietrager(rbind(DL_MFH, DL_SFH))
  bundlands_energietraeger_mfh <- average_by_year_energietrager(DL_MFH)
  bundlands_energietraeger_sfh <- average_by_year_energietrager(DL_SFH)

p <- plot_ly(type = 'bar', colors = "Blues") 
  
  p <- plot_ly(type = 'bar')
  v = TRUE
  for (i in 1:3) {
    if (i == 3)
      data <-  bundlands_energietraeger_sfh
    else if (i == 2)
      data <-  bundlands_energietraeger_mfh
    else
      data <- bundlands_energietraeger_all
    p <- p %>% add_trace(y = data$erdgas, name = 'Erdgas',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = data$fluessiggas, name = 'Fluessiggas',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = data$heizoel, name = 'Heizoel',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = data$holzpellets, name = 'Holzpellets',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = data$strom, name = 'Strom',  
                         x = 2002:2018, visible = v)
    p <- p %>% add_trace(y = data$waerme, name = 'Waerme',  
                         x = 2002:2018, visible = v)
  
    v = FALSE
  }
  
  p <- p %>% layout(
      xaxis = list(range = c(2001, 2019)),
      barmode='stack',
      colorway = c('#e8288a','#1f9d75', '#e2ab07', '#756eb2', '#d95e00', '#68a61e'))
  
  p <- p %>% layout(
    title = 'Percentual consumption per fuel',
    xaxis = list(title = "Year", range = c(2001, 2019)),
    yaxis = list(title = "Value"),
    barmode ='stack',
    updatemenus = list(
      list(
        buttons = get_visibility_combinations_co2()
      )
    )
  )
  return(p)
}
```


```{r}
get_co2_emissions_interactive_all <- function() {
  bundlands_energietraeger_all <- convert_area_to_co2_emissions_all(all_area, rbind(DL_MFH, DL_SFH), co2_coef)
  bundlands_energietraeger_mfh <- convert_area_to_co2_emissions_all(all_area, DL_MFH, co2_coef)
  bundlands_energietraeger_sfh <- convert_area_to_co2_emissions_all(all_area , DL_SFH, co2_coef)
  x_axis <- 2002:2017
  p <- plot_ly(type="scatter", mode="markers+lines")
  v = TRUE
  for (i in 1:3) {
    if (i == 3)
      data <-  bundlands_energietraeger_sfh
    else if (i == 2)
      data <-  bundlands_energietraeger_mfh
    else
      data <- bundlands_energietraeger_all
     p <- p %>% add_trace(x = x_axis, y = data$erdgas, name = 'Erdgas', visible = v, type = 'scatter',
             mode = 'lines+markers') 
     p <- p %>% add_trace(x = x_axis, y = data$fluessiggas, name = 'Fluessiggas', visible = v, type = 'scatter',
             mode = 'lines+markers') 
     p <- p %>% add_trace(x = x_axis, y = data$heizoel, name = 'Heizoel', visible = v, type = 'scatter',
             mode = 'lines+markers') 
     p <- p %>% add_trace(x = x_axis, y =data$holzpellets, name = 'Holzpellets',visible = v, type = 'scatter',
             mode = 'lines+markers') 
     p <- p %>%add_trace(x = x_axis, y = data$strom, name = 'Strom', visible = v, type = 'scatter',
             mode = 'lines+markers') 
     p <- p %>% add_trace(x = x_axis, y = data$waerme, name = 'Waerme', visible = v, type = 'scatter',
             mode = 'lines+markers') 
    v = FALSE
  }
  
  
  p <- p %>% layout(
      xaxis = list(range = c(2001, 2018)),
      colorway = c('#e8288a','#1f9d75', '#e2ab07', '#756eb2', '#d95e00', '#68a61e'))
  
  p <- p %>% layout(
    title = 'CO2 Emissions in all Germany (Megatonnes)',
    xaxis = list(title = "Year", range = c(2001, 2018)),
    yaxis = list(title = "Value"),
    barmode ='stack',
    updatemenus = list(
      list(
        buttons = get_visibility_combinations_co2()
      )
    )
  )
  return(p)
}

```



```{r}
get_co2_emissions_interactive <- function(data, energy_consumption_data, co2_coef, title) {
  bundlands_energietraeger <- convert_area_to_co2_emissions(data, energy_consumption_data, co2_coef)
  
  x_axis <- 2002:2018
  p <- plot_ly(type="scatter", mode="markers+lines")
  v = TRUE
  for (i in 1:length(states)) {
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$erdgas, name = 'Erdgas',  
                         x =  x_axis, visible = v,
             type = 'scatter',
             mode = 'lines+markers') 
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$fluessiggas, name = 'Fluessiggas',  
                         x = x_axis, visible = v,
                         
             type = 'scatter',
             mode = 'lines+markers') 
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$heizoel, name = 'Heizoel',  
                         x = x_axis, visible = v,
                         
             type = 'scatter',
             mode = 'lines+markers') 
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$holzpellets, name = 'Holzpellets',  
                         x = x_axis, visible = v,
                         
             type = 'scatter',
             mode = 'lines+markers') 
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$strom, name = 'Strom',  
                         x = x_axis, visible = v,
                         
             type = 'scatter',
             mode = 'lines+markers') 
    p <- p %>%  add_trace(y = bundlands_energietraeger[bundlands_energietraeger$bundesland == states[[i]],]$waerme, name = 'Waerme',  
                         x = x_axis, visible = v,
                         
             type = 'scatter',
             mode = 'lines+markers') 
  
    v = FALSE
  }
  
  
  p <- p %>% layout(
      xaxis = list(range = c(2001, 2019)),
      colorway = c('#e8288a','#1f9d75', '#e2ab07', '#756eb2', '#d95e00', '#68a61e'))
  
  p <- p %>% layout(
    title = title,
    xaxis = list(title = "Year", range = c(2001, 2019)),
    yaxis = list(title = "Value"),
    barmode ='stack',
    updatemenus = list(
      list(
        buttons = get_visibility_combinations()
      )
    )
  )
  return(p)
}

```

# 5a Proportions of energy produced by each fuel type

The following interactive graph shows the proportions of energy produced by the different fuels for multifamily, 1-2 family, and both combined building types. The building type can be chosen from the drop down on the left.

```{r,fig.cap="\\label{fig:figs}Fig. 9: Proportions of energy produced by the different fuels. Please use the drop down menu to choose the building type."}
get_relative_frequencies_interactive_all()
```
First let's point out that the heizoel is the most non eco-freindly fuel.
Waerme is the most friendly one and the others come after that one.
In this graph we can see that in general over the years erdgass and heizoel were mostly used,
then comes strom, and somewhere at the beginning of 2008 (although they were sold even before that) more people started to use 
holzpellets which have also very low influence in the co2 emissions.

In the multi-family houses we can see a drop down on the heizoel and an increase in the waerme,
which is not the case for single-family houses where the heizoel is kind of constant, but strom and holzpellets are more used since year 2009.

# 5b CO2 Emissons in all Germany

In this section we find the total energy produced by the different fuel sources used for heating of residential buildings. Since the data from co2online provide us with the specific energy consumption, we can multiply these with the offical numbers for the areas of residential buildings in Germany and get an estimate for the total energy consumed in Germany. We have collected the official figures in the file `Areas_SFH_MFH.csv` in the github repo. In the previous section we found the proportions of energy produced by each fuel type. With these proportions, we can find how much energy was produced by each fuel type. Furthermore, each fuel type has a co2 coefficient associated with it, and multiplying with this coefficient yields the amount of co2 produced. We have plotted the co2 produced in the following figure as an interactive graph showing the co2 emitted in Germany by the various fuel sources and the various building types. The drop down menu on the left enables one to select the building type.

```{r,fig.cap="\\label{fig:figs}Fig. 10: CO2 emissions by the different fuel types. Please use the drop down menu to choose the building type."}
get_co2_emissions_interactive_all()
```

When we see how the usage of these fuels effects the co2 emissions, in general we can say that that there are not a lot of changes all over Germany, except that the co2 emissions from the heizoel and erdgass change slightly in every, we could even say that there's a negative correlation between them.

For the MFH case we can see that the heizoel co2 emission starts to decrease over the years, and the co2 emission that come from the erdgass starts to increase.
There's a strong negative correlation between them. On the other hand when we take a look at the SFH we can see that the co2 emissions from the heizoel are the highest
and they still tend to increase.


# 6. Energy consumption trends across the 16 Federal states

In this section we consider trends in the specific energy consumption for each of the 16 federal states in Germany.

## 6a. Creating the dataframes

First we create data frames for `MFH`, `SFH` and `ALL` types of buildings.

```{r}
states <- sort(unique(DL_MFH$bundesland))
bundlands_SV_mfh <- list()
bundlands_SV_sfh <- list()
bundlands_SV_all <- list()
for (s in states) {
  bund_data_mfh <- DL_MFH[DL_MFH$bundesland == s  ,  ]
  specific_con <- getSpecificConsumptionByYear(mfh=bund_data_mfh , sfh=NULL , gtype="MFH")
  #above is a dataframe with columns "abrechnungsjahr","Area","Consumption","spz_verbrauch"
  bundlands_SV_mfh[[s]] <- specific_con
  #For SFH:
  bund_data_sfh <- DL_SFH[DL_SFH$bundesland == s  ,  ]
  specific_con <- getSpecificConsumptionByYear(mfh=NULL , sfh=bund_data_sfh , gtype="SFH")
  bundlands_SV_sfh[[s]] <- specific_con
  #For both:
  specific_con <- getSpecificConsumptionByYear(mfh=bund_data_mfh , sfh=bund_data_sfh , gtype="ALL")
  bundlands_SV_all[[s]] <- specific_con
}

#collect into single data frame - these will be used for plotting in plotly
bundSV_mfh_df <- data.frame(abrechnungsjahr=2002:2018)
bundSV_sfh_df <- data.frame(abrechnungsjahr=2002:2018)
bundSV_all_df <- data.frame(abrechnungsjahr=2002:2018)
for (s in names(bundlands_SV_mfh)) {
  bundSV_mfh_df[[s]] <- bundlands_SV_mfh[[s]]$spz_verbrauch
  bundSV_sfh_df[[s]] <- bundlands_SV_sfh[[s]]$spz_verbrauch
  bundSV_all_df[[s]] <- bundlands_SV_all[[s]]$spz_verbrauch
}
```

As an example, the dataframe `bundSV_mfh` looks as follows:

```{r}
bundSV_mfh_df
```

In the next sections we explore several visualization techniques for the above data.

## 6b. Specific Energy Consumption for MFH for the federal states

The next plot shows the specific energy consumption for the 16 federal states for multifamily houses in Germany from 2002-2018 as an interactive plot. The specific federal state can be selected from the drop-down menu and the plot corresponding to that state is exhibited.

```{r}
get_VC <- function() {
  visibility_combinations <- list()
  i = 1
  for (state in states) {
    to = 16
    vis <- rep(F, to)
    vis[i] <- TRUE
    visibility_combinations[[i]] <- list(method = "restyle",
                                         args = list("visible", as.list(vis)),
                                         label = state)
    i = i + 1
  }
  return(visibility_combinations)
}
```


```{r}
library(plotly)
p <- plot_ly(bundSV_mfh_df , x = ~abrechnungsjahr) %>%
  add_markers(y = ~get(states[1]), name = " ",marker=list(color="black")) %>%
  add_markers(y = ~get(states[2]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[3]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[4]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[5]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[6]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[7]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[8]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[9]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[10]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[11]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[12]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[13]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[14]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[15]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[16]), name = " " , marker=list(color="black"), visible = F)

#p <- plot_ly(bundSV_mfh_df , x = ~abrechnungsjahr) %>% add_markers(y = ~get(states[1]), name = " ",marker=list(color="black"))
#for (i in 2:16) {
#  p <- p %>% add_markers(y = ~get(states[i]), name = " " , marker=list(color="black"), visible = F)
#}

p <- p %>% layout(showlegend=FALSE,
  title = "Multifamily Houses",
  xaxis = list(title = "Year",tickvals=list(2002,2004,2006,2008,2010,2012,2014,2016,2018)),
  yaxis = list(title = "kWh/m2",range=c(0,150),tickvals=list(0,20,40,60,80,100,120,140)),
  updatemenus = list(
    list(
      buttons = get_VC()
    )
  )
)
```

```{r,fig.cap="\\label{fig:figs}Fig. 11: Interactive plot for the specific energy consumption for the 16 federal states for multifamily houses from 2002-2018."}
p
```


We can collect the data from all the states and years into a single heat map as follows:


```{r,fig.cap="\\label{fig:figs}Fig. 12: Heat map of the specific energy consumption for the year and the state for multifamily houses."}
library(plotly)

tmp <- aggregate(DL_MFH[,c('bundesland','abrechnungsjahr','verbrauch_gesamt_kwh_spez')][c(-1, -2)], by=list(DL_MFH$bundesland, DL_MFH$abrechnungsjahr), FUN = mean)
p <- plot_ly(
    x = tmp$Group.2, y = tmp$Group.1,
    z = tmp$verbrauch_gesamt_kwh_spez, type = "heatmap") %>% layout(
    title = 'Consumption per Bundesland and year for MFH',
    xaxis = list(range = 2012:2018))


p
```


The heat map above shows that Schleswig-Hosltein has quite high energy consumption comapred to the other states in the beginning, which can also be verified from the interactive plot in Fig. 5. For a comparison of how fast the specific energy consumption is falling, we have plotted the bar plots of the absolute values of the slopes of the linear trends in the next graph.

```{r,fig.cap="\\label{fig:figs}Fig. 13: Slopes of the linear trends in specific energy consumption for the 16 federal states for multifamily houses in Germany"}
abrechnungsjahr = 2002:2018
lm1 <- lm(as.matrix(bundSV_mfh_df[states[1]]) ~ abrechnungsjahr)
lm2 <- lm(as.matrix(bundSV_mfh_df[states[2]]) ~ abrechnungsjahr)
lm3 <- lm(as.matrix(bundSV_mfh_df[states[3]]) ~ abrechnungsjahr)
lm4 <- lm(as.matrix(bundSV_mfh_df[states[4]]) ~ abrechnungsjahr)
lm5 <- lm(as.matrix(bundSV_mfh_df[states[5]]) ~ abrechnungsjahr)
lm6 <- lm(as.matrix(bundSV_mfh_df[states[6]]) ~ abrechnungsjahr)
lm7 <- lm(as.matrix(bundSV_mfh_df[states[7]]) ~ abrechnungsjahr)
lm8 <- lm(as.matrix(bundSV_mfh_df[states[8]]) ~ abrechnungsjahr)
lm9 <- lm(as.matrix(bundSV_mfh_df[states[9]]) ~ abrechnungsjahr)
lm10 <- lm(as.matrix(bundSV_mfh_df[states[10]]) ~ abrechnungsjahr)
lm11 <- lm(as.matrix(bundSV_mfh_df[states[11]]) ~ abrechnungsjahr)
lm12 <- lm(as.matrix(bundSV_mfh_df[states[12]]) ~ abrechnungsjahr)
lm13 <- lm(as.matrix(bundSV_mfh_df[states[13]]) ~ abrechnungsjahr)
lm14 <- lm(as.matrix(bundSV_mfh_df[states[14]]) ~ abrechnungsjahr)
lm15 <- lm(as.matrix(bundSV_mfh_df[states[15]]) ~ abrechnungsjahr)
lm16 <- lm(as.matrix(bundSV_mfh_df[states[16]]) ~ abrechnungsjahr)
slope <- c(abs(summary(lm1)$coefficient[2]), abs(summary(lm2)$coefficient[2]), abs(summary(lm3)$coefficient[2]),abs(summary(lm4)$coefficient[2]), abs(summary(lm5)$coefficient[2]), abs(summary(lm6)$coefficient[2]),
abs(summary(lm7)$coefficient[2]), abs(summary(lm8)$coefficient[2]), abs(summary(lm9)$coefficient[2]), abs(summary(lm10)$coefficient[2]), abs(summary(lm11)$coefficient[2]), abs(summary(lm12)$coefficient[2]), abs(summary(lm13)$coefficient[2]), abs(summary(lm14)$coefficient[2]), abs(summary(lm15)$coefficient[2]), abs(summary(lm16)$coefficient[2]))
#slope <- sort(slope)
#states <- sort(unique(DL_MFH$bundesland))
mydata <-data.frame(slope, states)
mydata$states <- factor(mydata$states,levels=mydata$states[order(mydata$slope)])
p <-ggplot(mydata, aes(states, slope)) + geom_bar(stat = "identity")+ coord_flip()
p +labs(title="MFH",x="",y=bquote("kWh/(Year"~ m^2 ~ ")"))
```


We have presented the same data as above in an interactive map of the 16 federal states in the next figure. Please click on the respective state to see its name and the slope value in kWh/Year.


```{r}
slopes_data <- data.frame(bundesland=states)
slope_values_mfh <- NULL
slope_values_sfh <- NULL
slope_values_all <- NULL
for (s in states) {
  lm_sv_bund_mfh <- lm(spz_verbrauch ~ abrechnungsjahr , data = bundlands_SV_mfh[[s]])
  lm_sv_bund_sfh <- lm(spz_verbrauch ~ abrechnungsjahr , data = bundlands_SV_sfh[[s]])
  lm_sv_bund_all <- lm(spz_verbrauch ~ abrechnungsjahr , data = bundlands_SV_all[[s]])
  
  slope_values_mfh <- c(slope_values_mfh , lm_sv_bund_mfh$coefficients[2])
  slope_values_sfh <- c(slope_values_sfh , lm_sv_bund_sfh$coefficients[2])
  slope_values_all <- c(slope_values_all , lm_sv_bund_all$coefficients[2])
}
slopes_data$MFH <- slope_values_mfh 
slopes_data$SFH <- slope_values_sfh
slopes_data$ALL <- slope_values_all

library(sf)
library(dplyr)
library(ggplot2)
DL_map <- st_read("shapefiles/gadm36_DEU_shp/gadm36_DEU_1.shp",stringsAsFactors = FALSE,quiet = TRUE)
#DL_map <- st_read("~/Desktop/visualization-project2-smurfs/shapefiles/gadm36_DEU_shp/gadm36_DEU_1.shp",
#                 stringsAsFactors = FALSE)

library(tmap)
library(tmaptools)
DL_map$MFH <- slopes_data$MFH
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("MFH",
                               id="NAME_1",
                               popup.vars=c("MFH"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```
Fig. 14: Slopes of the linear trends in specific energy consumption for the 16 federal states for multifamily houses in Germany shown as an interactive map. Please click on the respective state to see the state name and the slope value in kWh/Year.
















## 6c. Specific Energy Consumption for 1-2 Family Houses for the federal states

The next plot shows the specific energy consumption for the 16 federal states for 1-2 family houses in Germany from 2002-2018 as an interactive plot. The specific federal state can be selected from the drop-down menu and the plot corresponding to that state is exhibited.


```{r,fig.cap="\\label{fig:figs}Fig. 15:  Interactive plot for the specific energy consumption for the 16 federal states for 1-2 family houses from 2002-2018."}
p <- plot_ly(bundSV_sfh_df , x = ~abrechnungsjahr) %>%
  add_markers(y = ~get(states[1]), name = " ",marker=list(color="black")) %>%
  add_markers(y = ~get(states[2]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[3]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[4]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[5]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[6]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[7]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[8]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[9]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[10]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[11]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[12]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[13]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[14]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[15]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[16]), name = " " , marker=list(color="black"), visible = F)

p <- p %>% layout(showlegend=FALSE,
  title = "1-2 Family Houses",
  xaxis = list(title = "Year",tickvals=list(2002,2004,2006,2008,2010,2012,2014,2016,2018)),
  yaxis = list(title = "kWh/m2",range=c(0,180),tickvals=list(0,20,40,60,80,100,120,140,160,180)),
  updatemenus = list(
    list(
      buttons = get_VC()
    )
  )
)

p
```



The same information can be put into a single heat map:

```{r,fig.cap="\\label{fig:figs}Fig. 16:  Heat map of the specific energy consumption for the year and the state for 1-2 family houses."}

library(plotly)

tmp <- aggregate(DL_SFH[,c('bundesland','abrechnungsjahr','verbrauch_gesamt_kwh_spez')][c(-1, -2)], by=list(DL_SFH$bundesland, DL_SFH$abrechnungsjahr), FUN = mean)
p <- plot_ly(
    x = tmp$Group.2, y = tmp$Group.1,
    z = tmp$verbrauch_gesamt_kwh_spez, type = "heatmap") %>% layout(
    title = 'Consumption per Bundesland and year for SFH',
    xaxis = list(range = 2012:2018))


p
```

The above graph shows that Hamburg had especially high energy consumption per unit area in the inital years, but this went down in later years.

We next plot the absolute values of the slopes of the linear trend for the specific consumption in the following graph for each of the federal state for SFH buildings. Hamburg has the fastest descent in the specific consumption for 1-2 family buildings.

```{r,fig.cap="\\label{fig:figs}Fig. 17:   Slopes of the linear trends in specific energy consumption for the 16 federal states for 1-2 family houses in Germany"}
lm1 <- lm(as.matrix(bundSV_sfh_df[states[1]]) ~ abrechnungsjahr)
lm2 <- lm(as.matrix(bundSV_sfh_df[states[2]]) ~ abrechnungsjahr)
lm3 <- lm(as.matrix(bundSV_sfh_df[states[3]]) ~ abrechnungsjahr)
lm4 <- lm(as.matrix(bundSV_sfh_df[states[4]]) ~ abrechnungsjahr)
lm5 <- lm(as.matrix(bundSV_sfh_df[states[5]]) ~ abrechnungsjahr)
lm6 <- lm(as.matrix(bundSV_sfh_df[states[6]]) ~ abrechnungsjahr)
lm7 <- lm(as.matrix(bundSV_sfh_df[states[7]]) ~ abrechnungsjahr)
lm8 <- lm(as.matrix(bundSV_sfh_df[states[8]]) ~ abrechnungsjahr)
lm9 <- lm(as.matrix(bundSV_sfh_df[states[9]]) ~ abrechnungsjahr)
lm10 <- lm(as.matrix(bundSV_sfh_df[states[10]]) ~ abrechnungsjahr)
lm11 <- lm(as.matrix(bundSV_sfh_df[states[11]]) ~ abrechnungsjahr)
lm12 <- lm(as.matrix(bundSV_sfh_df[states[12]]) ~ abrechnungsjahr)
lm13 <- lm(as.matrix(bundSV_sfh_df[states[13]]) ~ abrechnungsjahr)
lm14 <- lm(as.matrix(bundSV_sfh_df[states[14]]) ~ abrechnungsjahr)
lm15 <- lm(as.matrix(bundSV_sfh_df[states[15]]) ~ abrechnungsjahr)
lm16 <- lm(as.matrix(bundSV_sfh_df[states[16]]) ~ abrechnungsjahr)
library(ggplot2)
slope <- c(abs(summary(lm1)$coefficient[2]), abs(summary(lm2)$coefficient[2]), abs(summary(lm3)$coefficient[2]),abs(summary(lm4)$coefficient[2]), abs(summary(lm5)$coefficient[2]), abs(summary(lm6)$coefficient[2]),
abs(summary(lm7)$coefficient[2]), abs(summary(lm8)$coefficient[2]), abs(summary(lm9)$coefficient[2]), abs(summary(lm10)$coefficient[2]), abs(summary(lm11)$coefficient[2]), abs(summary(lm12)$coefficient[2]), abs(summary(lm13)$coefficient[2]), abs(summary(lm14)$coefficient[2]), abs(summary(lm15)$coefficient[2]), abs(summary(lm16)$coefficient[2]))
#slope <- sort(slope)
#states <- sort(unique(DL_MFH$bundesland))
mydata <-data.frame(slope, states)
mydata$states <- factor(mydata$states,levels=mydata$states[order(mydata$slope)])
p <-ggplot(mydata, aes(states, slope)) + geom_bar(stat = "identity")+ coord_flip()
p +labs(title="SFH",x="",y=bquote("kWh/(Year"~ m^2 ~ ")"))
```


In the next picture, we plot a map of the states of Germany colored by the slope value of that particular state for SFH buildings. We see that Hamburg has an unusually high slope, which dominates over all the other states.


```{r}
DL_map$SFH <- slopes_data$SFH #merge or inner_join gives error
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("SFH",
                               id="NAME_1",
                               popup.vars=c("SFH"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```
Fig. 18: Slopes of the linear trends in specific energy consumption for the 16 federal states for 1-2 family houses in Germany shown as an interactive map. Please click on the respective state to see the state name and the slope value in kWh/Year.



## 6d. Specific Energy Consumption for Multi and 1-2 Family Houses combined for the federal states

Here we look at the overall behavior of SFH+MFH buildings combined. The following is an interactive graph showing the specific energy consumption with the federal state being chosen by the drop down menu.

```{r,fig.cap="\\label{fig:figs}Fig. 19: Interactive plot for the specific energy consumption for the 16 federal states for both (MFH+SFH combined) type of buildings from 2002-2018. Use the drop down menu to select the federal state."}
p <- plot_ly(bundSV_all_df , x = ~abrechnungsjahr) %>%
  add_markers(y = ~get(states[1]), name = " ",marker=list(color="black")) %>%
  add_markers(y = ~get(states[2]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[3]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[4]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[5]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[6]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[7]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[8]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[9]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[10]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[11]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[12]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[13]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[14]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[15]), name = " " , marker=list(color="black"), visible = F) %>%
  add_markers(y = ~get(states[16]), name = " " , marker=list(color="black"), visible = F)
#https://stackoverflow.com/questions/34093169/horizontal-vertical-line-in-plotly
p <- p %>% layout(showlegend=FALSE,
  title = "Multi and 1-2 Family Houses",
  xaxis = list(title = "Year",tickvals=list(2002,2004,2006,2008,2010,2012,2014,2016,2018)),
  yaxis = list(title = "kWh/m2",range=c(0,160),tickvals=list(0,20,40,60,80,100,120,140,160)),
  shapes=list(type='line', x0= 2001, x1= 2001, y0=0, y1=160, line=list(width=1)),
  updatemenus = list(
    list(
      buttons = get_VC()
    )
  )
)

p
```

The next plot shows a heat map of the specific consumption plotted against the year and the federal state.

```{r,fig.cap="\\label{fig:figs}Fig. 20: Heat map of the specific energy consumption for the year and the state for MFH+SFH family houses."}
library(plotly)

bind <- rbind(DL_MFH,DL_SFH)[,c('bundesland','abrechnungsjahr','verbrauch_gesamt_kwh_spez')]
tmp <- aggregate(bind[c(-1, -2)], 
                 by=list(bind$bundesland, bind$abrechnungsjahr), FUN =mean)
p <- plot_ly(
    x = tmp$Group.2, y = tmp$Group.1,
    z = tmp$verbrauch_gesamt_kwh_spez, type = "heatmap") %>% layout(
    title = 'Consumption per Bundesland and year for MFH & SFH',
    xaxis = list(range = 2012:2018))


p
```

The next plot shows the absolute value of the slopes of each federal state.

```{r,fig.cap="\\label{fig:figs}Fig. 21: Slopes of the linear trends in specific energy consumption for the 16 federal states for MFH+SFH houses in Germany"}
lm1 <- lm(as.matrix(bundSV_all_df[states[1]]) ~ abrechnungsjahr)
lm2 <- lm(as.matrix(bundSV_all_df[states[2]]) ~ abrechnungsjahr)
lm3 <- lm(as.matrix(bundSV_all_df[states[3]]) ~ abrechnungsjahr)
lm4 <- lm(as.matrix(bundSV_all_df[states[4]]) ~ abrechnungsjahr)
lm5 <- lm(as.matrix(bundSV_all_df[states[5]]) ~ abrechnungsjahr)
lm6 <- lm(as.matrix(bundSV_all_df[states[6]]) ~ abrechnungsjahr)
lm7 <- lm(as.matrix(bundSV_all_df[states[7]]) ~ abrechnungsjahr)
lm8 <- lm(as.matrix(bundSV_all_df[states[8]]) ~ abrechnungsjahr)
lm9 <- lm(as.matrix(bundSV_all_df[states[9]]) ~ abrechnungsjahr)
lm10 <- lm(as.matrix(bundSV_all_df[states[10]]) ~ abrechnungsjahr)
lm11 <- lm(as.matrix(bundSV_all_df[states[11]]) ~ abrechnungsjahr)
lm12 <- lm(as.matrix(bundSV_all_df[states[12]]) ~ abrechnungsjahr)
lm13 <- lm(as.matrix(bundSV_all_df[states[13]]) ~ abrechnungsjahr)
lm14 <- lm(as.matrix(bundSV_all_df[states[14]]) ~ abrechnungsjahr)
lm15 <- lm(as.matrix(bundSV_all_df[states[15]]) ~ abrechnungsjahr)
lm16 <- lm(as.matrix(bundSV_all_df[states[16]]) ~ abrechnungsjahr)
slope <- c(abs(summary(lm1)$coefficient[2]), abs(summary(lm2)$coefficient[2]), abs(summary(lm3)$coefficient[2]),abs(summary(lm4)$coefficient[2]), abs(summary(lm5)$coefficient[2]), abs(summary(lm6)$coefficient[2]),
abs(summary(lm7)$coefficient[2]), abs(summary(lm8)$coefficient[2]), abs(summary(lm9)$coefficient[2]), abs(summary(lm10)$coefficient[2]), abs(summary(lm11)$coefficient[2]), abs(summary(lm12)$coefficient[2]), abs(summary(lm13)$coefficient[2]), abs(summary(lm14)$coefficient[2]), abs(summary(lm15)$coefficient[2]), abs(summary(lm16)$coefficient[2]))
#slope <- sort(slope)
#states <- sort(unique(DL_MFH$bundesland))
mydata <-data.frame(slope, states)
mydata$states <- factor(mydata$states,levels=mydata$states[order(mydata$slope)])
p <-ggplot(mydata, aes(states, slope)) + geom_bar(stat = "identity")+ coord_flip()
p +labs(title="ALL",x="",y=bquote("kWh/(Year"~ m^2 ~ ")"))
```

We see that Schleswig-Holstein and Hamburg are at positions 2 and 3, respectively, while Bremen goes to the top spot. 


In the next picture, we plot a map of the states of Germany colored by the slope value of that particular state for MFH+SFH buildings which corroborates the above statement.


```{r}
DL_map$ALL <- slopes_data$ALL #merge or inner_join gives error
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("ALL",
                               id="NAME_1",
                               popup.vars=c("ALL"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```
Fig. 22: Slopes of the linear trends in specific energy consumption for the 16 federal states for MFH+SFH family houses in Germany shown as an interactive map. Please click on the respective state to see the state name and the slope value in kWh/Year.













# 7. CO2 emission across the 16 federal states

In this section we analyze the CO2 emissions in each federal state of Germany.

## 7a. Percentage of fuel consumption split by the fuel source in each federal state (MFH+SFH combined)

First we compute and plot the proportions of energy produced by each fuel source for each year and in each federal state of Germany for MFH+SFH combined. The results are shown in the following figure as an interactive graph. Please select the state from the drop down menu.

```{r}
get_relative_frequencies_interactive(rbind(DL_SFH, DL_MFH), 'SFH & MFH - Percentual consumption per fuel by bundesland')
```
Fig. 23: Interactive graph showing proportions of energy produced by each fuel source for each year and in each federal state of Germany for MFH+SFH combined. The drop down menu on the left allows you to select the state.


When we see these trends by bundesland we can see that in general in Macklenburg-Vorpommern people tend to use heizoel. This numbers even increase over the years
but also, lately the strom and the holzpellets became an option to the people. We can see the same for Niedersachsen Nordrhein-Westfalen, Hamburg, Hessen.
In other bundeslaender however, like Berlin, Saarland there's an increased number of people who use strom and the usage of heizoel drops down. This data will be better explained by the lines below.


## 7b. CO2 Emissions for each federal state (MFH + SFH combined)

With the help of the official figures for the areas in each federal state (given in the files `MFHAreas_bundeslands.csv` and `SFHAreas_bundeslands.csv` in the repo) and the specific consumption obtained from the co2online data we can calculate the total energy consumed in each bundesland in each year. With the help of the energy proportions split by `energietraeger`, found in the previous section, we can find the proportion of energy produced by each fuel type. Using the co2 coefficients then lets us estimate the co2 produced. The following graph shows the co2 produced in an interactive way, with the drop down menu allowing you to choose the federal state.


```{r}
library(plotly)
library(tidyr)

get_co2_emissions_interactive(mfh_area, rbind(DL_SFH, DL_MFH), co2_coef, 'SFH & MFH - CO2 Emissions by Bundesland')
```
Fig. 24: co2 emissions for MFH+SFH combined. Use the drop down menu to select the bundesland.


We can see in the plot below that there was a period from 2009-2015 where people were using strom to heat their homes, thus there was a large co2 emission from there. First we thought that this was because the prices whent down,
but we checked that information and it wasn't orrect. Same as before, when the erdgass prices and the heizoel have negative correlation. We can also conclude that there's drop in the heizoel consumption lately.


## 7c. Percentage of fuel consumption split by the fuel source in each federal state (MFH)

Below we plot the proprotion of energy produced by each fuel type for MFH buildings as an interactive plot. The state can be selected from the drop down menu.

```{r}
get_relative_frequencies_interactive(DL_MFH, 'MFH - Percentual consumption per fuel by bundesland')
```
Fig. 25: Percentage or energy produced by the different fuel types for MFH buildings. Use the drop down meun to select the state.


When we make comparison between the MFH and the SFH consumptions by year and bundesland we can see that in the MFH case especially in Hessen, Hamburg there's stil a large percentage of people who use heizoel, but and interesing state is Sachsen-Anhalt the largest percentage of consumption goes to  erdgass, there's a drop in the heizoel consumption and increase in the holzpellets

## 7d. CO2 Emissions for each federal state (MFH)

The following graph shows the co2 emissions for each fuel type and each federal state in an interactive graph for MFH buildings. The state can be selected by the drop down menu.

```{r}
library(plotly)
library(tidyr)

get_co2_emissions_interactive(mfh_area, DL_MFH, co2_coef, 'MFH - Co2 Emissions by Bundesland (Megatonnes)')
```
Fig. 26: CO2 emissions for MFH buildings in each federal state. Select the federal state from teh drop down menu.

We can see the similar results here, especially for Hamburg, more specifically until 2014 there was a large co2 emission from waerme. Lately they tend to use heizoel. In Badem-Wuertemberg the started to use Waerme more and significanlty reduced the CO2 emissions from heizoel


## 7e. Percentage of fuel consumption split by the fuel source in each federal state (SFH)

Below we plot the proprotion of energy produced by each fuel type for SFH buildings as an interactive plot. The state can be selected from the drop down menu.


```{r}
get_relative_frequencies_interactive(DL_SFH, 'SFH - Percentual consumption per fuel by bundesland')
```
Fig. 27: Percentage or energy produced by the different fuel types for SFH buildings. Use the drop down menu to select the state.


In the case of SFH, we can see that Baden-Wuerttemberg was the leader in heizoel consumption, This trend however tends to drop down. Also in Mecklenburg-Vorprommern people still tend to use heizoel.
They also started using strom lately. 

## 7f. CO2 Emissions for each federal state (SFH)

The following graph shows the co2 emissions for each fuel type and each federal state in an interactive graph for SFH buildings. The state can be selected by the drop down menu.

```{r}
library(plotly)
library(tidyr)

get_co2_emissions_interactive(mfh_area, DL_SFH, co2_coef, 'SFH - Co2 Emissions by Bundesland  (Megatonnes)')
```
Fig. 28: CO2 emissions for SFH buildings in each federal state. Select the federal state from teh drop down menu.


Regarding the co2 emission, an interesing state is Sachsen-Anhalt where we can see that they don't use heizoel and erdgass lately, but they tend to use strom.




## 7g. Eco-friendliness in 2018 


In this subsection we can see how eco-friendly the states are now, in all Germany, for both MFH & SFH, then MFH and SFH separately. We get these numbers by a sequence of compuatations and specific co2 coefficients so that every fuel i s kind of weighted when contirbuting to the co2 emissions.

```{r}
library(tmap)
library(tmaptools)

DL_map <- st_read("shapefiles/gadm36_DEU_shp/gadm36_DEU_1.shp",stringsAsFactors = FALSE,quiet = TRUE)
map_data <- get_map_data_co2()

DL_map$ALL <- map_data$ALL
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("ALL",
                               id="NAME_1",
                               popup.vars=c("ALL"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```



```{r}
library(tmap)
library(tmaptools)

DL_map$MFH <- map_data$MFH
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("MFH",
                               id="NAME_1",
                               popup.vars=c("MFH"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```

```{r}
library(tmap)
library(tmaptools)

DL_map$SFH <- map_data$SFH
tmap_mode("view")
tm_shape(DL_map) + tm_polygons("SFH",
                               id="NAME_1",
                               popup.vars=c("SFH"),
                               style="cont",
                               midpoint=NA,
                               palette="seq"
                               #legend.reverse=TRUE - Gives WRONG info!
)+tm_layout(aes.palette=list(seq="-RdYlGn"))
```
From all three plots we can conclude that Hessen is the worst bundesland in terms of eco-friendliness, next are Nordrhein-Westfalen, Rheinland-Pfalz and Brandenburg. It's interesting to notice that in Brandenburg the MFH houses use better fuels than the SFH. Another interesting thing is that Bayern is very eco-friendly and has less CO2 emissions than Hessen even though it has twice (12,997,204) the Inhabitants of Hessen.


# 8. SOM interpretations of the data

In this section we're goint to take a look in other parameters that contribute to the energy consumption in all german districts. We're taking into account latitude, longitude, gebaeude_baujahr, and, gebaeude_nutzfleche

# 8a SOM interpretations of MFH

```{r}
library(plotly)
library(tidyr)
plot_som(DL_MFH)
```


# 8b SOM interpretations of SFH
```{r}
library(plotly)
library(tidyr)
plot_som(DL_SFH)
```

# Conclusions



Lately temperatures tend to drop and so does the energy consumption. The cold winter of 2010 shows up in the plot as an increase in the specific consumption for that year. Regarding the fuels and the co2 emissions, MFH buildings tend to use more environmental friendly fuels, such as waerme and erdgass,
but SFH houses tend to use heizoel. Holzpellets are a new trend and people tend to use them more. Erdgas is one of mostly used and also eco-friendly. Hessen is the state which produces the most co2 emissions. Saarland, Hmaburg and Bayern are among the most eco-friendly states and have lowest numbers of co2 emissions.